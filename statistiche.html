<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistiche - Club del Biliardo</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Club del Biliardo</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="giocatori.html">Giocatori</a>
      <a href="luoghi.html">Luoghi</a>
      <a href="partite.html">Partite</a>
      <a href="statistiche.html" aria-current="page">Statistiche</a>
    </nav>
  </header>

  <main>
    <h2>Classifica Giocatori</h2>
    <div id="tabellaStatistiche"></div>
  </main>

  <script src="js/main.js"></script>
  <script>
    function calcolaStatistiche() {
      if (giocatori.length === 0) {
        document.getElementById("tabellaStatistiche").innerHTML = "<p>Nessun giocatore registrato</p>";
        return;
      }

      const stats = giocatori.map((g, idx) => {
        let partiteGiocate = 0, vittorie = 0, sconfitte = 0, pareggi = 0;
        let miniVinte = 0, miniPerse = 0;

        partite.forEach(p => {
          if (p.giocatori.includes(idx)) {
            partiteGiocate++;
            const pos = p.giocatori.indexOf(idx);
            const isTeam1 = (p.modalita === "singolo") ? (pos === 0) : (pos === 0 || pos === 1);
            const score = isTeam1 ? p.vittorie[0] : p.vittorie[1];
            const oppScore = isTeam1 ? p.vittorie[1] : p.vittorie[0];

            // Vittoria / Sconfitta / Pareggio
            if (score > oppScore) vittorie++;
            else if (score < oppScore) sconfitte++;
            else pareggi++;

            // Mini partite vinte / perse
            if (p.dettagli) {
              p.dettagli.forEach((res, i) => {
                const isMyWin = (isTeam1 && res === "V") || (!isTeam1 && res === "P");
                if (isMyWin) miniVinte++;
                else miniPerse++;
              });
            }
          }
        });

        const winrate = partiteGiocate > 0 ? (vittorie / partiteGiocate) * 100 : 0;

        // Indice di abilità (max 100)
        const totaleMini = miniVinte + miniPerse;
        const miniScore = totaleMini > 0 ? (miniVinte / totaleMini) * 100 : 0;
        const indiceAbilita = (winrate * 0.7 + miniScore * 0.3) * (Math.log(1 + partiteGiocate) / Math.log(1 + 30));

        return {
          nome: g.nome,
          nickname: g.nickname,
          partiteGiocate,
          vittorie,
          sconfitte,
          pareggi,
          winrate,
          miniVinte,
          miniPerse,
          indiceAbilita: indiceAbilita > 100 ? 100 : indiceAbilita
        };
      });

      stats.sort((a, b) => b.indiceAbilita - a.indiceAbilita);

      const table = `
        <table class="stats-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Giocatore</th>
              <th>Partite</th>
              <th>V</th>
              <th>P</th>
              <th>S</th>
              <th>% Vittorie</th>
              <th>Mini vinte</th>
              <th>Mini perse</th>
              <th>Indice abilità</th>
            </tr>
          </thead>
          <tbody>
            ${stats.map((s, i) => `
              <tr>
                <td>${i+1}</td>
                <td>${s.nome} (${s.nickname})</td>
                <td>${s.partiteGiocate}</td>
                <td style="color:green">${s.vittorie}</td>
                <td style="color:orange">${s.pareggi}</td>
                <td style="color:red">${s.sconfitte}</td>
                <td>${s.winrate.toFixed(1)}%</td>
                <td>${s.miniVinte}</td>
                <td>${s.miniPerse}</td>
                <td><strong>${s.indiceAbilita.toFixed(1)}%</strong></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      document.getElementById("tabellaStatistiche").innerHTML = table;
    }

    document.addEventListener("DOMContentLoaded", calcolaStatistiche);
  </script>
</body>
</html>
