<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giocatori - Club del Biliardo</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Club del Biliardo</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="giocatori.html" aria-current="page">Giocatori</a>
      <a href="luoghi.html">Luoghi</a>
      <a href="partite.html">Partite</a>
      <a href="statistiche.html">Statistiche</a>
    </nav>
  </header>

  <main>
    <h2>Gestione Giocatori</h2>

    <form id="formGiocatore">
      <input type="text" id="nome" placeholder="Nome" required>
      <input type="text" id="nickname" placeholder="Nickname" required>
      <input type="email" id="email" placeholder="Email">
      <input type="text" id="specialita" placeholder="Specialit√†">
      <input type="file" id="foto" accept="image/*">
      <button type="submit">Aggiungi Giocatore</button>
    </form>

    <h3>Lista Giocatori</h3>
    <div id="listaGiocatori"></div>
  </main>

  <!-- Modal dettaglio giocatore -->
  <div id="modalGiocatore" class="modal">
    <div class="modal-content">
      <span class="close" onclick="chiudiModal()">&times;</span>
      <div id="contenutoGiocatore"></div>
    </div>
  </div>

  <script src="js/main.js"></script>
  <script>
    function aggiornaListaGiocatori() {
      const div = document.getElementById("listaGiocatori");
      div.innerHTML = "";

      if (giocatori.length === 0) {
        div.innerHTML = "<p>Nessun giocatore registrato</p>";
        return;
      }

      giocatori.forEach((g, i) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <strong>${g.nome}</strong> (${g.nickname})<br>
          <small>${g.specialita || "-"}</small><br>
          <button onclick="apriSchedaGiocatore(${i})">üëÄ Dettagli</button>
          <button onclick="eliminaGiocatore(${i})" class="delete">‚ùå Elimina</button>
        `;
        div.appendChild(card);
      });
    }

    function apriSchedaGiocatore(idx) {
      const g = giocatori[idx];

      // Statistiche base
      let vittorie = 0, sconfitte = 0, pareggi = 0, miniVinte = 0, miniPerse = 0;
      const partiteGiocatore = [];

      partite.forEach((p, i) => {
        if (p.giocatori.includes(idx)) {
          const pos = p.giocatori.indexOf(idx);
          const isTeam1 = (p.modalita === "singolo") ? (pos === 0) : (pos === 0 || pos === 1);
          const score = isTeam1 ? p.vittorie[0] : p.vittorie[1];
          const oppScore = isTeam1 ? p.vittorie[1] : p.vittorie[0];

          if (score > oppScore) vittorie++;
          else if (score < oppScore) sconfitte++;
          else pareggi++;

          if (p.dettagli) {
            p.dettagli.forEach((res) => {
              const isMyWin = (isTeam1 && res === "V") || (!isTeam1 && res === "P");
              if (isMyWin) miniVinte++;
              else miniPerse++;
            });
          }

          partiteGiocatore.push({
            data: p.data,
            avversari: p.giocatori.filter((_, j) => j !== pos).map(j => giocatori[p.giocatori[j]]?.nome || "?"),
            risultato: `${score}-${oppScore}`
          });
        }
      });

      // Ultime 5 partite
      const ultime = partiteGiocatore.slice(-5).reverse();

      const modal = document.getElementById("modalGiocatore");
      const content = document.getElementById("contenutoGiocatore");
      content.innerHTML = `
        <h3>${g.nome} (${g.nickname})</h3>
        <p><strong>Email:</strong> ${g.email || "-"}</p>
        <p><strong>Specialit√†:</strong> ${g.specialita || "-"}</p>
        <p><strong>Statistiche:</strong><br>
          Vittorie: <span style="color:green">${vittorie}</span> |
          Pareggi: <span style="color:orange">${pareggi}</span> |
          Sconfitte: <span style="color:red">${sconfitte}</span><br>
          Mini vinte: ${miniVinte} | Mini perse: ${miniPerse}
        </p>
        <h4>Ultime 5 partite</h4>
        <ul>
          ${ultime.length > 0 ? ultime.map(p => `<li>${p.data}: ${p.risultato} vs ${p.avversari.join(", ")}</li>`).join("") : "<li>Nessuna partita</li>"}
        </ul>
        <button onclick="modificaGiocatore(${idx})">‚úèÔ∏è Modifica</button>
      `;
      modal.style.display = "block";
    }

    function chiudiModal() {
      document.getElementById("modalGiocatore").style.display = "none";
    }

    function modificaGiocatore(idx) {
      const g = giocatori[idx];
      document.getElementById("nome").value = g.nome;
      document.getElementById("nickname").value = g.nickname;
      document.getElementById("email").value = g.email;
      document.getElementById("specialita").value = g.specialita;
      eliminaGiocatore(idx);
      chiudiModal();
    }

    document.getElementById("formGiocatore").addEventListener("submit", (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value.trim();
      const nickname = document.getElementById("nickname").value.trim();
      const email = document.getElementById("email").value.trim();
      const specialita = document.getElementById("specialita").value.trim();

      giocatori.push({ nome, nickname, email, specialita });
      salvaLocalStorage();
      aggiornaListaGiocatori();
      e.target.reset();
    });

    document.addEventListener("DOMContentLoaded", aggiornaListaGiocatori);
  </script>
</body>
</html>
