<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partite - Club del Biliardo</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Club del Biliardo</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="giocatori.html">Giocatori</a>
      <a href="luoghi.html">Luoghi</a>
      <a href="partite.html" aria-current="page">Partite</a>
      <a href="statistiche.html">Statistiche</a>
    </nav>
  </header>

  <main>
    <h2>Gestione Partite</h2>

    <form id="formPartita">
      <label>Tipo di gioco:</label>
      <select id="tipoGioco" required>
        <option value="8-15">8-15</option>
        <option value="a-punti">A punti</option>
      </select>

      <label>Modalità:</label>
      <select id="modalitaGioco" required>
        <option value="singolo">Singolo</option>
        <option value="coppia">Coppia</option>
      </select>

      <label>Luogo:</label>
      <select id="luogoPartita" required></select>

      <label>Data:</label>
      <input type="date" id="dataPartita" required>

      <div id="giocatoriContainer"></div>

      <h3>Mini-partite (V/P)</h3>
      <div id="miniPartite"></div>
      <button type="button" onclick="aggiungiMiniPartita()">➕ Aggiungi mini-partita</button>

      <button type="submit" style="margin-top:1rem;">Salva Partita</button>
    </form>

    <h3>Partite Registrate</h3>
    <div id="listaPartite"></div>
  </main>

  <script src="js/main.js"></script>
  <script>
    function aggiornaLuoghiDropdown() {
      const select = document.getElementById("luogoPartita");
      select.innerHTML = "<option value=''>-- seleziona --</option>";
      luoghi.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l.id;
        opt.textContent = l.nome;
        select.appendChild(opt);
      });
    }

    function aggiornaGiocatoriDropdown() {
      const container = document.getElementById("giocatoriContainer");
      container.innerHTML = "";
      const modalita = document.getElementById("modalitaGioco").value;

      if (modalita === "singolo") {
        container.innerHTML = `
          <label>Giocatore 1:</label>
          <select id="player1">${giocatori.map((g,i)=>`<option value="${i}">${g.nome}</option>`).join("")}</select>
          <label>Giocatore 2:</label>
          <select id="player2">${giocatori.map((g,i)=>`<option value="${i}">${g.nome}</option>`).join("")}</select>
        `;
      } else {
        container.innerHTML = `
          <h4>Squadra 1</h4>
          <label>Giocatore 1:</label>
          <select id="player1">${giocatori.map((g,i)=>`<option value="${i}">${g.nome}</option>`).join("")}</select>
          <label>Giocatore 2:</label>
          <select id="player2">${giocatori.map((g,i)=>`<option value="${i}">${g.nome}</option>`).join("")}</select>
          <h4>Squadra 2</h4>
          <label>Giocatore 3:</label>
          <select id="player3">${giocatori.map((g,i)=>`<option value="${i}">${g.nome}</option>`).join("")}</select>
          <label>Giocatore 4:</label>
          <select id="player4">${giocatori.map((g,i)=>`<option value="${i}">${g.nome}</option>`).join("")}</select>
        `;
      }
    }

    function aggiungiMiniPartita() {
      const div = document.createElement("div");
      div.className = "mini-partita";
      div.innerHTML = `
        <select>
          <option value="V">V</option>
          <option value="P">P</option>
        </select>
        <button type="button" onclick="this.parentElement.remove()">❌</button>
      `;
      document.getElementById("miniPartite").appendChild(div);
    }

    document.getElementById("formPartita").addEventListener("submit", (e) => {
      e.preventDefault();

      const tipo = document.getElementById("tipoGioco").value;
      const modalita = document.getElementById("modalitaGioco").value;
      const luogo = document.getElementById("luogoPartita").value;
      const data = document.getElementById("dataPartita").value;

      let giocatoriSelezionati = [];
      if (modalita === "singolo") {
        giocatoriSelezionati = [
          parseInt(document.getElementById("player1").value),
          parseInt(document.getElementById("player2").value)
        ];
      } else {
        giocatoriSelezionati = [
          parseInt(document.getElementById("player1").value),
          parseInt(document.getElementById("player2").value),
          parseInt(document.getElementById("player3").value),
          parseInt(document.getElementById("player4").value)
        ];
      }

      const dettagli = Array.from(document.querySelectorAll("#miniPartite select")).map(s => s.value);
      const vittorie = [
        dettagli.filter(v => v === "V").length,
        dettagli.filter(v => v === "P").length
      ];

      partite.push({ tipo, modalita, luogo, data, giocatori: giocatoriSelezionati, vittorie, dettagli });
      salvaLocalStorage();
      aggiornaListaPartite();
      e.target.reset();
      document.getElementById("miniPartite").innerHTML = "";
    });

    function aggiornaListaPartite() {
      const div = document.getElementById("listaPartite");
      div.innerHTML = "";

      if (partite.length === 0) {
        div.innerHTML = "<p>Nessuna partita registrata</p>";
        return;
      }

      [...partite].reverse().forEach((p, i) => {
        const card = document.createElement("div");
        card.className = "card";

        let giocatoriTxt = "";
        if (p.modalita === "singolo") {
          giocatoriTxt = `${giocatori[p.giocatori[0]]?.nome || "?"} vs ${giocatori[p.giocatori[1]]?.nome || "?"}`;
        } else {
          giocatoriTxt = `${giocatori[p.giocatori[0]]?.nome || "?"} & ${giocatori[p.giocatori[1]]?.nome || "?"} vs ${giocatori[p.giocatori[2]]?.nome || "?"} & ${giocatori[p.giocatori[3]]?.nome || "?"}`;
        }

        card.innerHTML = `
          <strong>${p.tipo} (${p.modalita})</strong><br>
          <em>${p.data}</em> - ${luoghi.find(l => l.id === p.luogo)?.nome || "-"}<br>
          ${giocatoriTxt}<br>
          <small>Risultato: ${p.vittorie[0]} - ${p.vittorie[1]}</small><br>
          <button onclick="eliminaPartita(${partite.length - 1 - i})" class="delete">Elimina</button>
        `;
        div.appendChild(card);
      });
    }

    function eliminaPartita(idx) {
      if (confirm("Vuoi eliminare questa partita?")) {
        partite.splice(idx, 1);
        salvaLocalStorage();
        aggiornaListaPartite();
      }
    }

    document.getElementById("modalitaGioco").addEventListener("change", aggiornaGiocatoriDropdown);

    document.addEventListener("DOMContentLoaded", () => {
      aggiornaLuoghiDropdown();
      aggiornaGiocatoriDropdown();
      aggiornaListaPartite();
    });
  </script>
</body>
</html>
